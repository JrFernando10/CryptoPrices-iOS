trigger:
  branches:
    include:
      - master

pool:
  vmImage: 'macos-latest'

variables:
  scheme: 'CryptoPrices-iOS'
  project: 'CryptoPrices-iOS.xcodeproj'
  testCoverageThreshold: 85

stages:
- stage: BuildAndTest
  jobs:
  - job: Build
    steps:
    - task: Checkout@1

    - task: CmdLine@2
      displayName: 'Build Xcode project'
      inputs:
        script: |
          xcodebuild -project $(project) \
                     -scheme $(scheme) \
                     -sdk iphonesimulator \
                     -destination 'platform=iOS Simulator,name=iPhone 14,OS=17.4' \
                     build

    - task: CmdLine@2
      displayName: 'Run Unit Tests with Coverage'
      inputs:
        script: |
          xcodebuild test \
                     -project $(project) \
                     -scheme $(scheme) \
                     -sdk iphonesimulator \
                     -destination 'platform=iOS Simulator,name=iPhone 14,OS=17.4' \
                     -enableCodeCoverage YES \
                     | tee xcode-test.log

    - task: CmdLine@2
      displayName: 'Check Test Coverage'
      inputs:
        script: |
          DERIVED_DATA=$(xcodebuild -project $(project) -scheme $(scheme) -showBuildSettings | grep -m1 'OBJROOT =' | awk '{print $3}' | sed 's|/Build/Intermediates.noindex|/Build/Intermediates.noindex/CodeCoverage|')
          PROF_DATA=$(find "$DERIVED_DATA" -name '*.profdata' | head -n 1)
          APP_BINARY=$_
